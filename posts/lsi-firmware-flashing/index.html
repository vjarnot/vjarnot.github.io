<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>LSI HBA Flashing | Zeroth Oughts</title><meta name=keywords content="nas,hba,sas,lsi,9300-8i,truenas,datahoarder"><meta name=description content="I recently acquired an LSI 9300-8i Supermicro HBA and needed to flash the firmware for use with TrueNAS... the process was more of a hassle than I'd expected."><meta name=author content="Voytek Jarnot"><link rel=canonical href=https://vjarnot.github.io/posts/lsi-firmware-flashing/><link crossorigin=anonymous href=/assets/css/stylesheet.min.6fe19c3c76b734f2e4ef9cfbdd63ff9f914d85720bffc5f85f04dcd45d18e6fb.css integrity="sha256-b+GcPHa3NPLk75z73WP/n5FNhXIL/8X4XwTc1F0Y5vs=" rel="preload stylesheet" as=style><link rel=icon href=https://vjarnot.github.io/favicon.ico><link rel=apple-touch-icon href=https://vjarnot.github.io/apple-touch-icon.png><meta name=twitter:title content="LSI HBA Flashing | Zeroth Oughts"><meta name=twitter:description content="I recently acquired an LSI 9300-8i Supermicro HBA and needed to flash the firmware for use with TrueNAS... the process was more of a hassle than I'd expected."><meta property="og:title" content="LSI HBA Flashing | Zeroth Oughts"><meta property="og:description" content="I recently acquired an LSI 9300-8i Supermicro HBA and needed to flash the firmware for use with TrueNAS... the process was more of a hassle than I'd expected."><meta property="og:type" content="article"><meta property="og:url" content="https://vjarnot.github.io/posts/lsi-firmware-flashing/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-11T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-11T00:00:00+00:00"><meta property="og:site_name" content="Zeroth Oughts"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://vjarnot.github.io/posts/"},{"@type":"ListItem","position":2,"name":"LSI HBA Flashing","item":"https://vjarnot.github.io/posts/lsi-firmware-flashing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"LSI HBA Flashing | Zeroth Oughts","name":"LSI HBA Flashing","description":"I recently acquired an LSI 9300-8i Supermicro HBA and needed to flash the firmware for use with TrueNAS... the process was more of a hassle than I'd expected.","keywords":["nas","hba","sas","lsi","9300-8i","truenas","datahoarder"],"wordCount":"1030","inLanguage":"en","datePublished":"2023-02-11T00:00:00Z","dateModified":"2023-02-11T00:00:00Z","author":{"@type":"Person","name":"Voytek Jarnot"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://vjarnot.github.io/posts/lsi-firmware-flashing/"},"publisher":{"@type":"Organization","name":"Zeroth Oughts","logo":{"@type":"ImageObject","url":"https://vjarnot.github.io/favicon.ico"}}}</script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary-bg:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list-page{background:var(--theme)}.list-page:not(.dark)::-webkit-scrollbar-track{background:0 0}.list-page:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="light",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://vjarnot.github.io/ accesskey=h title="Zeroth Oughts (Alt + H)">Zeroth Oughts</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://vjarnot.github.io/archives/ title=Archives>Archives</a></li><li><a href=https://vjarnot.github.io/tags/ title=Tags>Tags</a></li><li><a href=https://vjarnot.github.io/search/ title="Search (Alt + /)" data-no-instant accesskey=/>Search</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><h1 class=post-title>LSI HBA Flashing</h1><div class=post-description>I recently acquired an LSI 9300-8i Supermicro HBA and needed to flash the firmware for use with TrueNAS... the process was more of a hassle than I'd expected.</div><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>February 11, 2023</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select:text"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" style="user-select:text"/><line x1="7" y1="7" x2="7" y2="7" style="user-select:text"/></svg>
<span class=post-tags><a href=https://vjarnot.github.io/tags/nas/>nas</a><a href=https://vjarnot.github.io/tags/hba/>hba</a><a href=https://vjarnot.github.io/tags/sas/>sas</a><a href=https://vjarnot.github.io/tags/lsi/>lsi</a><a href=https://vjarnot.github.io/tags/9300-8i/>9300-8i</a><a href=https://vjarnot.github.io/tags/truenas/>truenas</a><a href=https://vjarnot.github.io/tags/datahoarder/>datahoarder</a></span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg>
<span>1030 words</span></span></div></header><div class="toc side left"><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#lsi-hba-it-mode-firmware-flashing aria-label="LSI HBA IT-mode Firmware Flashing">LSI HBA IT-mode Firmware Flashing</a></li><li><a href=#background aria-label=Background>Background</a></li><li><a href=#so-what aria-label="So what?">So what?</a></li><li><a href=#so-why-are-we-flashing-firmware aria-label="So why are we flashing firmware?">So why are we flashing firmware?</a><ul><li><a href=#but-seriously-why aria-label="But seriously, why?">But seriously, why?</a></li></ul></li><li><a href=#flashing aria-label=Flashing>Flashing</a><ul><li><a href=#overview aria-label=Overview>Overview</a></li><li><a href=#tldr-lets-flash aria-label="TL;DR: Let&amp;rsquo;s Flash!">TL;DR: Let&rsquo;s Flash!</a></li></ul></li><li><a href=#additional-thoughts aria-label="Additional Thoughts">Additional Thoughts</a></li></ul></div></details></div><div class=post-content><h2 id=lsi-hba-it-mode-firmware-flashing>LSI HBA IT-mode Firmware Flashing<a hidden class=anchor aria-hidden=true href=#lsi-hba-it-mode-firmware-flashing>Â¶</a></h2><p>Oh, what fun we&rsquo;ll have: Flashing an IT-mode firmware to an LSI 9300-8i Supermicro HBA on a UEFI system.</p><p>You&rsquo;re likely here because - like me - you&rsquo;re struggling to either figure out how to flash your HBA,
or how to get your relatively-recent desktop PC to actually boot FreeDOS and work (spoiler: I don&rsquo;t go down the FreeDOS route here).</p><p>If you want a real guide, read this: <a href=https://www.truenas.com/community/resources/detailed-newcomers-guide-to-crossflashing-lsi-9211-9300-9305-9311-9400-94xx-hba-and-variants.54/ target=_blank rel=noopener>https://www.truenas.com/community/resources/detailed-newcomers-guide-to-crossflashing-lsi-9211-9300-9305-9311-9400-94xx-hba-and-variants.54/</a></p><p><strong>If my rambling doesn&rsquo;t interest you, <a href=#tldr-lets-flash>skip down to the good stuff</a></strong></p><h2 id=background>Background<a hidden class=anchor aria-hidden=true href=#background>Â¶</a></h2><p>Currently the media and other bulk-storage needs of our household are handled by an Intel Rapid Storage RAID 5 array of 4x 3TB disks sitting in my desktop PC.
This arrangement may sound impressive if your concept of bulk storage is limited to finding yet another cheap external hard drive to plug in,
but is laughable to the NAS-enthusiast community.</p><p>Given that it&rsquo;s time for a new PC for myself, I got to thinking about acquiring a &lsquo;proper&rsquo; consumer-grade NAS to untether my day-to-day computer from its
NAS-ish duties. As tends to happen, the rabbit-hole of research led to me learn a bit about Synology and its competitors, work out a game-plan, get an Amazon
shopping cart populated and ready to go, and completely change my mind and reverse course.</p><p>Enter the new plan: build myself a new PC, repurpose current PC to serve as a NAS. Enter TrueNAS: <a href=https://www.truenas.com/truenas-scale/ target=_blank rel=noopener>https://www.truenas.com/truenas-scale/</a></p><h2 id=so-what>So what?<a hidden class=anchor aria-hidden=true href=#so-what>Â¶</a></h2><p>So the recommended approaches for TrueNAS are</p><ul><li>Buy a box from iXsystems</li><li>Buy a server on eBay, modify as/if needed, and install TrueNAS</li></ul><p>Those don&rsquo;t meet my goal of repurposing my existing desktop PC, so I&rsquo;ll be going with the <strong>not</strong>-particularly-recommended route of:</p><ul><li>Do what you can to a PC to make it TrueNAS-viable <em>(for home use, if you&rsquo;re doing this professionally, close this browser tab immediately)</em>.</li></ul><p>So under the guise of doing what&rsquo;s reasonable to make this not suck, I&rsquo;ll be reusing the PC, but hooking up new HDDs to a Host Bus Adapater (HBA) rather
than directly to the SATA ports of my motherboard.</p><h2 id=so-why-are-we-flashing-firmware>So why are we flashing firmware?<a hidden class=anchor aria-hidden=true href=#so-why-are-we-flashing-firmware>Â¶</a></h2><p>The canonically-recommended HBAs for TrueNAS are those that utilize LSI chips. A ton of different manufacturers have made HBAs with these chips.
Within that plethora, there&rsquo;s the 92xx series, the 93xx series, and others - this is definitely <em>not</em> the place to learn all about LSI HBAs.</p><p>I&rsquo;ll be using a Supermicro card with a 9300-8i chip on it, because that&rsquo;s the one I got on eBay. If you&rsquo;re heading down this path, do your research
and confirm that the card you&rsquo;re buying has the chip you want (and you want that chip because you read enough on the TrueNAS forums to know it&rsquo;ll work).</p><h3 id=but-seriously-why>But seriously, why?<a hidden class=anchor aria-hidden=true href=#but-seriously-why>Â¶</a></h3><p>This is over-simplified to a probably-dangerous point, but here goes:</p><p>HBAs operate in one of two (that we&rsquo;re concerned with) modes:</p><ul><li>IR: RAID mode <strong>[no bueno]</strong></li><li>IT: not RAID mode <strong>[yes bueno]</strong></li></ul><p>For use with TrueNAS, your HBA <em><strong>absolutely must</strong></em> be in IT mode - and this is set via the firmware that your HBA is running. So - we need to flash
the IT mode firmware to our HBA.</p><p>Also, there&rsquo;s this: <a href=https://www.truenas.com/community/resources/lsi-9300-xx-firmware-update.145/ target=_blank rel=noopener>https://www.truenas.com/community/resources/lsi-9300-xx-firmware-update.145/</a>
.
Specifically for the LSI 9300 series, IT mode is not enough, it needs to be IT mode using the specific firmware version available for download at that link.</p><h2 id=flashing>Flashing<a hidden class=anchor aria-hidden=true href=#flashing>Â¶</a></h2><h3 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>Â¶</a></h3><p>We need four things: the HBA (installed), the firmware file, the software to flash the firmware to the card, and a USB stick.
We&rsquo;ve covered the first two, regarding the third: you&rsquo;re going to want sas<strong>2</strong>flash for 92xx cards, and sas<strong>3</strong>flash for 93xx cards.</p><p><a href=https://www.broadcom.com/support/knowledgebase/1211161501344/flashing-firmware-and-bios-on-lsi-sas-hbas target=_blank rel=noopener>https://www.broadcom.com/support/knowledgebase/1211161501344/flashing-firmware-and-bios-on-lsi-sas-hbas</a></p><h3 id=tldr-lets-flash>TL;DR: Let&rsquo;s Flash!<a hidden class=anchor aria-hidden=true href=#tldr-lets-flash>Â¶</a></h3><ol><li>Format your USB stick to FAT32 <em>(no you <strong>don&rsquo;t</strong> need a bootable disk, just standard FAT32)</em></li><li>Download EFI Shell: <a href=https://github.com/pbatard/UEFI-Shell target=_blank rel=noopener>https://github.com/pbatard/UEFI-Shell</a>
<em>(click on Releases and download the ISO)</em><ol><li>Extract the ISO</li><li>Make an <code>efi/boot</code> directory structure on your USB stick</li><li>Copy <code>bootx64.efi</code> from the ISO to <code>/efi/boot/</code> on the USB stick</li></ol></li><li>Download sas3flash.efi (or sas2flash.efi if you&rsquo;re flashing a 92xx card):
<a href=https://www.broadcom.com/support/knowledgebase/1211161501344/flashing-firmware-and-bios-on-lsi-sas-hbas target=_blank rel=noopener>https://www.broadcom.com/support/knowledgebase/1211161501344/flashing-firmware-and-bios-on-lsi-sas-hbas</a>
<em>(very bottom of the page, note we want the EFI version)</em><ol><li>Copy <code>sas3flash.efi</code> to the root directory of your USB stick</li></ol></li><li>Acquire firmware - you can probably find this on Broadcom&rsquo;s site, after much googling and reading the TrueNAS forums for the right link for your card. Or use the
version from <a href=https://www.truenas.com/community/resources/lsi-9300-xx-firmware-update.145/ target=_blank rel=noopener>https://www.truenas.com/community/resources/lsi-9300-xx-firmware-update.145/</a>
if you&rsquo;ve got a 9300-xx card.<ol><li>Copy <code>SAS9300_8i_IT.bin</code> <em>(find the file that matches the chip on your card)</em> to the root directory of your USB stick</li></ol></li><li>Disable secure boot in your BIOS <em>(on my ASUS mb, this required getting into the Advanced settings)</em></li><li>Boot your USB stick</li></ol><p>Now you&rsquo;re in an EFI shell! If it&rsquo;s your first time, yes, I agree, it does look like an OS from the 80s.</p><p>Here are the commands I used to flash my firmware:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>fs0:
</span></span><span class=line><span class=cl>sas3flash.efi -listall
</span></span><span class=line><span class=cl>sas3flash.efi -c <span class=m>0</span> -list
</span></span><span class=line><span class=cl>sas3flash.efi -c <span class=m>0</span> -f FILENAME
</span></span><span class=line><span class=cl>sas3flash.efi -c <span class=m>0</span> -list 
</span></span></code></pre></td></tr></table></div></div><ol><li><code>fs0:</code> - this is us just changing &ldquo;directories&rdquo; to get to our USB stick root <em>(the 0 may vary if you&rsquo;ve got multiple USB drives plugged in)</em></li><li><code>sas3flash.efi -listall</code> - you&rsquo;re going to want to see your HBA show up here, if it doesn&rsquo;t there&rsquo;s no point in proceeding</li><li><code>sas3flash.efi -c 0 -list</code> - I assume that, like me, there&rsquo;s only one HBA in your system, so we reference it as <code>0</code><ol><li>This&rsquo;ll show you what firmware you&rsquo;ve currently got, as well as the mode (IR or IT) your HBA is in</li><li>While you&rsquo;re here, write down your SAS address, it may come in handy</li></ol></li><li><code>sas3flash.efi -c 0 -f FILENAME</code><ol><li>This is where the magic happens, in my case FILENAME was <code>SAS9300_8i_IT.bin</code></li></ol></li><li><code>sas3flash.efi -c 0 -list</code> - Confirmation: check that your firmware version is what you want it to be, and that you&rsquo;re in IT mode</li></ol><h2 id=additional-thoughts>Additional Thoughts<a hidden class=anchor aria-hidden=true href=#additional-thoughts>Â¶</a></h2><p>These cards are designed for server chassis running in racks in datacenters. I.e., lots and lots of airflow: fans so loud that you&rsquo;d
never allow them in your house. So they&rsquo;ve got heatsinks but no fans on the cards, I&rsquo;ve rigged a 40mm fan (<a href=https://amzn.to/3If9J1I target=_blank rel=noopener>https://amzn.to/3If9J1I</a>
) to mine,
I recommend you do the same.</p></div><footer class=post-footer><nav class=paginav><a class=next href=https://vjarnot.github.io/posts/github-pages-and-hugo-bootstrap/><span class=title>Next Page&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>Github Pages and Hugo</span></a></nav></footer><div class=comments-separator></div></article></main><footer class=footer><span>&copy; 2023 <a href=https://vjarnot.github.io/>Zeroth Oughts</a></span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a></span>
<span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script>
<script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a="1"=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script><script>mediumZoom(".entry-cover img"),mediumZoom(".post-content img:not([no-zoom])")</script></body></html>